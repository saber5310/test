<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ليجا شوت - متابعة المباريات لحظة بلحظة</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* جميع أنماط CSS السابقة تبقى كما هي */
    </style>
</head>
<body>
    <div class="container">
        <!-- الهيكل نفسه كما في الكود السابق -->
    </div>

    <script>
        class FootballTracker {
            constructor() {
                this.API_KEY = '6e3b092a4b344c0f9423da618b038123'; // مفتاح API فعلي
                this.BASE_URL = 'https://api.football-data.org/v4';
                this.STATE = {
                    matches: [],
                    competitions: [],
                    favorites: JSON.parse(localStorage.getItem('favorites')) || [],
                    activeTab: 'all',
                    isLoading: false,
                    lastUpdated: null
                };

                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadInitialData();
                this.setupAutoRefresh();
                this.render();
            }

            async loadInitialData() {
                try {
                    this.STATE.isLoading = true;
                    
                    const [matchesRes, competitionsRes] = await Promise.all([
                        this.fetchData('/matches'),
                        this.fetchData('/competitions')
                    ]);

                    this.STATE.matches = matchesRes.matches;
                    this.STATE.competitions = competitionsRes.competitions;
                    this.STATE.lastUpdated = new Date();
                    
                } catch (error) {
                    this.showError(this.getErrorMessage(error));
                } finally {
                    this.STATE.isLoading = false;
                    this.render();
                }
            }

            async fetchData(endpoint) {
                const cacheKey = endpoint;
                const cachedData = this.getFromCache(cacheKey);

                if (cachedData) return cachedData;

                const response = await fetch(`${this.BASE_URL}${endpoint}`, {
                    headers: { 'X-Auth-Token': this.API_KEY }
                });

                if (!response.ok) throw new Error(response.status);

                const data = await response.json();
                this.saveToCache(cacheKey, data);
                return data;
            }

            getFromCache(key) {
                const item = localStorage.getItem(key);
                if (!item) return null;

                const { data, timestamp } = JSON.parse(item);
                const now = new Date().getTime();
                
                // صلاحية التخزين المؤقت: 15 دقيقة
                return (now - timestamp < 900000) ? data : null;
            }

            saveToCache(key, data) {
                const cacheItem = {
                    data: data,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem(key, JSON.stringify(cacheItem));
            }

            setupAutoRefresh() {
                // تحديث تلقائي كل دقيقة للمباريات الحية
                setInterval(async () => {
                    if (this.STATE.activeTab === 'live') {
                        const liveMatches = await this.fetchData('/matches?status=LIVE');
                        this.updateLiveMatches(liveMatches.matches);
                        this.render();
                    }
                }, 60000);
            }

            updateLiveMatches(newMatches) {
                this.STATE.matches = this.STATE.matches.map(match => {
                    const updatedMatch = newMatches.find(m => m.id === match.id);
                    return updatedMatch || match;
                });
            }

            // باقي الدوال (render, filterMatches, generateMatchesHTML...) تبقى كما هي مع تحسينات

            getErrorMessage(error) {
                const errorMessages = {
                    403: 'صلاحية المفتاح منتهية',
                    429: 'تم تجاوز الحد المسموح من الطلبات',
                    500: 'مشكلة في الخادم الداخلي',
                    default: 'فشل في جلب البيانات'
                };
                
                return errorMessages[error.message] || errorMessages.default;
            }

            toggleFavorite(matchId) {
                const index = this.STATE.favorites.indexOf(matchId);
                const newFavorites = index === -1 
                    ? [...this.STATE.favorites, matchId]
                    : this.STATE.favorites.filter(id => id !== matchId);

                this.STATE.favorites = newFavorites;
                localStorage.setItem('favorites', JSON.stringify(newFavorites));
                this.render();
            }

            showError(message) {
                const container = document.getElementById('matchesContainer');
                container.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>حدث خطأ!</h3>
                        <p>${message}</p>
                        <button class="retry-btn" onclick="location.reload()">
                            <i class="fas fa-redo"></i> إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }

        // تهيئة التطبيق
        window.tracker = new FootballTracker();
    </script>
</body>
</html>
