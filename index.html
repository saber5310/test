<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>ليجا شوت - متابعة المباريات</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="api-football.css">
    </head>
    <body>
        <header class="main-header">
            <div class="header-content">
                <h1 class="logo">
                    <i class="fas fa-futbol"></i> ليجا شوت
                </h1>
                <div class="current-date" id="current-date"></div>
            </div>
        </header>

        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-btn active" data-tab="live">
                    <i class="fas fa-play-circle"></i> الجارية
                </button>
                <button class="tab-btn" data-tab="upcoming">
                    <i class="fas fa-clock"></i> القادمة
                </button>
                <button class="tab-btn" data-tab="finished">
                    <i class="fas fa-check-circle"></i> المنتهية
                </button>
            </div>
        </div>

        <!-- ويدجت API الأصلية -->
        <div id="wg-api-football-fixtures"
            data-host="v3.football.api-sports.io"
            data-refresh="60"
            data-key="376800a4f1a5582465b88e9c37d3f326"
            data-theme="false"
            data-show-errors="true"
            style="display:none;">
        </div>

        <div id="matches-container">
            <div id="live-matches" class="matches-section active"></div>
            <div id="upcoming-matches" class="matches-section"></div>
            <div id="finished-matches" class="matches-section"></div>
        </div>

        <script src="https://widgets.api-sports.io/football/1.1.8/widget.js"></script>
        <script>
            // دالة لعرض التاريخ الحالي
            function displayCurrentDate() {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const today = new Date();
                document.getElementById('current-date').textContent = today.toLocaleDateString('ar-EG', options);
            }

            // دالة لتصنيف المباريات
            function classifyMatch(match) {
                const status = match.fixture.status.short;
                const liveStatuses = ['1H', 'HT', '2H', 'ET', 'P', 'BT'];
                const finishedStatuses = ['FT', 'AET', 'PEN'];
                
                if (liveStatuses.includes(status)) return 'live';
                if (finishedStatuses.includes(status)) return 'finished';
                return 'upcoming';
            }

            // دالة لتحويل بيانات الودجت إلى بطاقاتنا
            function processWidgetData() {
                const widget = document.getElementById('wg-api-football-fixtures');
                const matches = JSON.parse(widget.getAttribute('data-fixtures'));
                
                if (!matches || matches.length === 0) {
                    document.getElementById('live-matches').innerHTML = '<div class="no-matches">لا توجد مباريات اليوم</div>';
                    return;
                }
                
                organizeMatches(matches);
            }

            // دالة لتنظيم المباريات
            function organizeMatches(matches) {
                const containers = {
                    live: document.getElementById('live-matches'),
                    upcoming: document.getElementById('upcoming-matches'),
                    finished: document.getElementById('finished-matches')
                };

                // تفريغ الحاويات أولاً
                Object.values(containers).forEach(container => {
                    container.innerHTML = '';
                });

                // تجميع المباريات حسب النوع والدوري
                const organizedMatches = {
                    live: {},
                    upcoming: {},
                    finished: {}
                };

                matches.forEach(match => {
                    const type = classifyMatch(match);
                    const leagueName = match.league.name;
                    
                    if (!organizedMatches[type][leagueName]) {
                        organizedMatches[type][leagueName] = [];
                    }
                    organizedMatches[type][leagueName].push(match);
                });

                // عرض المباريات في الأقسام المناسبة
                for (const [type, leagues] of Object.entries(organizedMatches)) {
                    if (Object.keys(leagues).length === 0) {
                        containers[type].innerHTML = `<div class="no-matches">لا توجد مباريات ${getTypeName(type)}</div>`;
                        continue;
                    }

                    for (const [leagueName, leagueMatches] of Object.entries(leagues)) {
                        const leagueHtml = createLeagueHtml(leagueName, leagueMatches, type);
                        containers[type].innerHTML += leagueHtml;
                    }
                }

                // بدء العد التنازلي للمباريات القادمة
                startCountdowns();
            }

            // دالة لإنشاء HTML للدوري
            function createLeagueHtml(leagueName, matches, type) {
                let html = `
                    <div class="league-section">
                        <div class="league-header">
                            <img src="${matches[0].league.logo}" alt="${leagueName}" class="league-logo">
                            <span>${leagueName}</span>
                        </div>
                        <div class="league-matches">
                `;

                matches.forEach(match => {
                    html += createMatchCardHtml(match, type);
                });

                html += `
                        </div>
                    </div>
                `;

                return html;
            }

            // دالة لإنشاء HTML لبطاقة المباراة
            function createMatchCardHtml(match, type) {
                const matchTime = new Date(match.fixture.timestamp * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const statusClass = `status-${type}`;
                const countdownId = type === 'upcoming' ? `countdown-${match.fixture.id}` : '';

                return `
                    <div class="match-card ${statusClass}" onclick="openMatchDetails(${match.fixture.id})">
                        <div class="teams">
                            <div class="team">
                                <img src="${match.teams.home.logo}" alt="${match.teams.home.name}" class="team-logo">
                                <span class="team-name">${match.teams.home.name}</span>
                            </div>
                            <div class="vs">
                                <div class="score">${match.goals.home} - ${match.goals.away}</div>
                                ${type === 'upcoming' ? 
                                    `<div id="${countdownId}" class="countdown"></div>` : 
                                    `<div>VS</div>`}
                            </div>
                            <div class="team">
                                <img src="${match.teams.away.logo}" alt="${match.teams.away.name}" class="team-logo">
                                <span class="team-name">${match.teams.away.name}</span>
                            </div>
                        </div>
                        <div class="match-info">
                            <span class="match-time">${matchTime}</span>
                            <span class="match-status ${statusClass}">${match.fixture.status.long}</span>
                        </div>
                    </div>
                `;
            }

            // دالة لبدء العد التنازلي
            function startCountdowns() {
                const upcomingMatches = document.querySelectorAll('#upcoming-matches .match-card');
                
                upcomingMatches.forEach(matchCard => {
                    const fixtureId = matchCard.onclick.toString().match(/openMatchDetails\((\d+)\)/)[1];
                    const countdownElement = matchCard.querySelector('.countdown');
                    if (!countdownElement) return;
                    
                    const matchTime = new Date(parseInt(fixtureId) * 1000);
                    updateCountdown(countdownElement, matchTime);
                    
                    const countdownInterval = setInterval(() => {
                        updateCountdown(countdownElement, matchTime);
                    }, 1000);
                });
            }

            // دالة لتحديث العد التنازلي
            function updateCountdown(element, matchTime) {
                const now = new Date();
                const diff = matchTime - now;
                
                if (diff <= 0) {
                    element.textContent = "بدأت!";
                    clearInterval(element.intervalId);
                    return;
                }
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                element.textContent = `${hours} س ${minutes} د ${seconds} ث`;
            }

            // دالة لفتح تفاصيل المباراة
            function openMatchDetails(fixtureId) {
                window.open(`match-details.html?id=${fixtureId}`, '_blank');
            }

            // دالة للحصول على اسم النوع بالعربية
            function getTypeName(type) {
                const names = {
                    live: 'جارية',
                    upcoming: 'قادمة',
                    finished: 'منتهية'
                };
                return names[type] || '';
            }

            // إعداد تبويبات المباريات
            function setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-btn');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // إزالة النشط من جميع الأزرار
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        // إضافة النشط للزر المحدد
                        button.classList.add('active');
                        
                        // إخفاء جميع الأقسام
                        document.querySelectorAll('.matches-section').forEach(section => {
                            section.classList.remove('active');
                        });
                        
                        // إظهار القسم المحدد
                        const tab = button.dataset.tab;
                        document.getElementById(`${tab}-matches`).classList.add('active');
                    });
                });
            }

            // تهيئة الصفحة عند التحميل
            document.addEventListener('DOMContentLoaded', () => {
                displayCurrentDate();
                setupTabs();
                
                // الانتظار حتى تحميل الودجت ثم معالجة البيانات
                const checkWidget = setInterval(() => {
                    const widget = document.getElementById('wg-api-football-fixtures');
                    if (widget.getAttribute('data-fixtures')) {
                        clearInterval(checkWidget);
                        processWidgetData();
                    }
                }, 500);
            });
        </script>
    </body>
</html>