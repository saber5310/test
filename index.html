<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ليجا شوت - متابعة المباريات مباشرة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a6bff;
            --secondary-color: #ff6b6b;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --border-radius: 10px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            background: linear-gradient(135deg, var(--dark-color), var(--primary-color));
            color: white;
            padding: 1rem 0;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-left: 10px;
            color: var(--secondary-color);
        }

        .search-container {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 5px 10px;
            width: 300px;
            transition: var(--transition);
        }

        .search-container:focus-within {
            background: rgba(255, 255, 255, 0.3);
            width: 350px;
        }

        .search-container input {
            background: transparent;
            border: none;
            color: white;
            padding: 8px;
            width: 100%;
            outline: none;
        }

        .search-container input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-container button {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
        }

        .notification-btn {
            background: var(--secondary-color);
            border: none;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: var(--transition);
        }

        .notification-btn:hover {
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .main-content {
            padding: 2rem 0;
        }

        .tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            position: relative;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--primary-color);
            font-weight: 700;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }

        .tab:hover:not(.active) {
            color: var(--dark-color);
            background: rgba(0, 0, 0, 0.05);
        }

        .matches-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 1.5rem;
        }

        .match-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .match-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .match-card.favorite::before {
            content: '\f005';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 10px;
            left: 10px;
            color: var(--warning-color);
            z-index: 1;
            font-size: 1.2rem;
        }

        .match-card.live {
            border-left: 4px solid var(--danger-color);
        }

        .match-card.finished {
            border-left: 4px solid var(--success-color);
        }

        .match-card.upcoming {
            border-left: 4px solid var(--info-color);
        }

        .match-header {
            padding: 1rem;
            background: var(--dark-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .league-info {
            display: flex;
            align-items: center;
        }

        .league-logo {
            width: 30px;
            height: 30px;
            margin-left: 10px;
            border-radius: 50%;
            object-fit: contain;
            background: white;
            padding: 2px;
        }

        .league-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .match-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: 500;
        }

        .status-live {
            background: var(--danger-color);
            animation: pulse 1.5s infinite;
        }

        .status-finished {
            background: var(--success-color);
        }

        .status-upcoming {
            background: var(--info-color);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .match-content {
            padding: 1.5rem 1rem;
        }

        .teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40%;
        }

        .team-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .team-name {
            font-weight: 500;
            text-align: center;
        }

        .match-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 20%;
        }

        .score {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .match-time {
            font-size: 0.9rem;
            color: #666;
        }

        .match-details {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            font-size: 0.8rem;
            color: #666;
        }

        .match-venue {
            display: flex;
            align-items: center;
        }

        .match-venue i {
            margin-left: 5px;
        }

        .match-actions {
            display: flex;
        }

        .action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            margin-right: 10px;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .action-btn:hover {
            color: var(--primary-color);
        }

        .action-btn i {
            margin-left: 5px;
        }

        .countdown {
            font-size: 0.9rem;
            color: var(--info-color);
            font-weight: 500;
            margin-top: 5px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            text-align: center;
            padding: 2rem;
            color: var(--danger-color);
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 2rem auto;
            width: 90%;
            max-width: 800px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 1.5rem;
            background: var(--dark-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--secondary-color);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .match-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .match-info-section {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: var(--border-radius);
        }

        .info-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
            color: var(--dark-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }

        .info-item {
            display: flex;
            margin-bottom: 0.5rem;
        }

        .info-label {
            font-weight: 500;
            width: 120px;
            color: #666;
        }

        .info-value {
            flex: 1;
        }

        .events-timeline {
            margin-top: 2rem;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #eee;
        }

        .timeline-time {
            width: 50px;
            font-weight: 500;
            color: var(--dark-color);
        }

        .timeline-event {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .event-icon {
            width: 24px;
            height: 24px;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: 50%;
            font-size: 0.7rem;
        }

        .goal {
            background: var(--success-color);
        }

        .yellow-card {
            background: var(--warning-color);
        }

        .red-card {
            background: var(--danger-color);
        }

        .substitution {
            background: var(--info-color);
        }

        .event-team {
            font-weight: 500;
            width: 120px;
        }

        .event-player {
            flex: 1;
        }

        .share-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 2100;
            display: none;
        }

        .share-modal h3 {
            margin-bottom: 1rem;
            color: var(--dark-color);
        }

        .share-buttons {
            display: flex;
            gap: 10px;
        }

        .share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .share-btn:hover {
            transform: scale(1.1);
        }

        .facebook {
            background: #3b5998;
        }

        .twitter {
            background: #1da1f2;
        }

        .whatsapp {
            background: #25d366;
        }

        .copy-link {
            background: var(--primary-color);
        }

        .standings-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: none;
        }

        .standings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .standings-table th {
            background: var(--dark-color);
            color: white;
            padding: 0.8rem;
            text-align: right;
            font-weight: 500;
        }

        .standings-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
            text-align: right;
        }

        .standings-table tr:hover {
            background: #f9f9f9;
        }

        .team-standing {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .team-standing-logo {
            width: 25px;
            height: 25px;
            margin-right: 10px;
        }

        .team-standing-name {
            font-weight: 500;
        }

        .position {
            font-weight: 700;
            color: var(--dark-color);
        }

        .promotion {
            background: rgba(40, 167, 69, 0.1);
        }

        .relegation {
            background: rgba(220, 53, 69, 0.1);
        }

        .ad-space {
            background: #f0f0f0;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1.5rem 0;
            padding: 1rem;
            border-radius: var(--border-radius);
            color: #666;
            font-size: 0.9rem;
        }

        .ad-leaderboard {
            width: 100%;
            height: 90px;
        }

        .ad-responsive {
            width: 100%;
            height: 250px;
        }

        .ad-card {
            width: 100%;
            height: 100px;
        }

        footer {
            background: var(--dark-color);
            color: white;
            padding: 2rem 0;
            margin-top: 2rem;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .footer-section {
            flex: 1;
            min-width: 250px;
            margin-bottom: 1.5rem;
            padding: 0 1rem;
        }

        .footer-section h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

        .footer-section ul {
            list-style: none;
        }

        .footer-section li {
            margin-bottom: 0.5rem;
        }

        .footer-section a {
            color: #ddd;
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-section a:hover {
            color: var(--secondary-color);
        }

        .social-links {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }

        .social-link {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .social-link:hover {
            background: var(--secondary-color);
            transform: translateY(-3px);
        }

        .copyright {
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: #aaa;
        }

        /* Responsive styles */
        @media (max-width: 992px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .search-container {
                width: 100%;
            }

            .search-container:focus-within {
                width: 100%;
            }

            .match-info {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 5px;
            }

            .tab {
                padding: 0.8rem 1rem;
            }

            .matches-container {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
            }
        }

        /* Animation classes */
        .flip-in {
            animation: flipIn 0.5s ease;
        }

        @keyframes flipIn {
            from { transform: rotateX(90deg); opacity: 0; }
            to { transform: rotateX(0); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <span>ليجا شوت</span>
                <i class="fas fa-futbol"></i>
            </div>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ابحث عن مباراة أو فريق...">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <button class="notification-btn" id="notification-btn">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notification-badge">0</span>
            </button>
        </div>
    </header>

    <div class="container main-content">
        <div class="ad-space ad-leaderboard">
            مساحة إعلانية - 728x90
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="all">كل المباريات</div>
            <div class="tab" data-tab="live">المباريات الجارية</div>
            <div class="tab" data-tab="upcoming">المباريات القادمة</div>
            <div class="tab" data-tab="finished">المباريات المنتهية</div>
            <div class="tab" data-tab="standings">ترتيب الدوريات</div>
            <div class="tab" data-tab="favorites">المفضلة</div>
        </div>

        <div id="league-filter" style="margin-bottom: 1rem; display: none;">
            <select id="league-select" class="form-control">
                <option value="">كل الدوريات</option>
            </select>
        </div>

        <div id="matches-content">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <div class="standings-container" id="standings-container">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <div class="ad-space ad-responsive">
            مساحة إعلانية متجاوبة
        </div>
    </div>

    <footer>
        <div class="container footer-content">
            <div class="footer-section">
                <h3>عن ليجا شوت</h3>
                <p>منصة متكاملة لمتابعة المباريات والبطولات الرياضية حول العالم بأحدث الإحصائيات والتفاصيل.</p>
                <div class="social-links">
                    <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
            <div class="footer-section">
                <h3>روابط سريعة</h3>
                <ul>
                    <li><a href="#">الصفحة الرئيسية</a></li>
                    <li><a href="#">المباريات اليوم</a></li>
                    <li><a href="#">ترتيب الفرق</a></li>
                    <li><a href="#">أهم البطولات</a></li>
                    <li><a href="#">التنبيهات</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>الدوريات</h3>
                <ul>
                    <li><a href="#">الدوري السعودي</a></li>
                    <li><a href="#">الدوري المصري</a></li>
                    <li><a href="#">الدوري الإنجليزي</a></li>
                    <li><a href="#">الدوري الإسباني</a></li>
                    <li><a href="#">دوري أبطال أوروبا</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>اتصل بنا</h3>
                <ul>
                    <li><i class="fas fa-envelope"></i> info@legashot.com</li>
                    <li><i class="fas fa-phone"></i> +966 12 345 6789</li>
                    <li><i class="fas fa-map-marker-alt"></i> الرياض، المملكة العربية السعودية</li>
                </ul>
            </div>
        </div>
        <div class="copyright">
            &copy; 2023 ليجا شوت. جميع الحقوق محفوظة.
        </div>
    </footer>

    <!-- Match Details Modal -->
    <div class="modal" id="match-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">تفاصيل المباراة</h3>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="share-modal" id="share-modal">
        <h3>شارك المباراة</h3>
        <div class="share-buttons">
            <div class="share-btn facebook" data-platform="facebook">
                <i class="fab fa-facebook-f"></i>
            </div>
            <div class="share-btn twitter" data-platform="twitter">
                <i class="fab fa-twitter"></i>
            </div>
            <div class="share-btn whatsapp" data-platform="whatsapp">
                <i class="fab fa-whatsapp"></i>
            </div>
            <div class="share-btn copy-link" data-platform="copy">
                <i class="fas fa-copy"></i>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_CONFIG = {
            BASE_URL: 'https://v3.football.api-sports.io',
            API_KEY: 'd25a9ad97ac2539d41139cf4490aab', // Partial key for security
            ENDPOINTS: {
                FIXTURES: '/fixtures',
                STANDINGS: '/standings',
                LEAGUES: '/leagues'
            },
            CACHE: {
                TTL: 15 * 60 * 1000, // 15 minutes in milliseconds
                PREFIX: 'LEGASHOT_'
            },
            REQUEST_LIMIT: 100, // Daily limit
            LIVE_UPDATE_INTERVAL: 30000 // 30 seconds for live matches
        };

        // Application State
        const STATE = {
            currentTab: 'all',
            matches: [],
            filteredMatches: [],
            leagues: [],
            favorites: JSON.parse(localStorage.getItem('legashot_favorites')) || [],
            notifications: [],
            apiRequestsCount: 0,
            lastUpdateTime: 0,
            lastTabSwitchTime: 0,
            TAB_SWITCH_CACHE_THRESHOLD: 30000, // 30 seconds
            liveUpdateInterval: null,
            selectedLeague: null,
            searchQuery: '',
            isModalOpen: false,
            currentMatchId: null
        };

        // DOM Elements
        const DOM = {
            tabs: document.querySelectorAll('.tab'),
            matchesContent: document.getElementById('matches-content'),
            standingsContainer: document.getElementById('standings-container'),
            leagueFilter: document.getElementById('league-filter'),
            leagueSelect: document.getElementById('league-select'),
            searchInput: document.getElementById('search-input'),
            searchBtn: document.getElementById('search-btn'),
            notificationBtn: document.getElementById('notification-btn'),
            notificationBadge: document.getElementById('notification-badge'),
            matchModal: document.getElementById('match-modal'),
            closeModal: document.getElementById('close-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            shareModal: document.getElementById('share-modal')
        };

        // Initialize the application
        function init() {
            setupEventListeners();
            loadLeagues();
            loadMatches();
            updateNotificationBadge();
            registerServiceWorker();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Tab switching
            DOM.tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // League filter
            DOM.leagueSelect.addEventListener('change', (e) => {
                STATE.selectedLeague = e.target.value || null;
                filterMatches();
            });

            // Search functionality
            DOM.searchBtn.addEventListener('click', handleSearch);
            DOM.searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleSearch();
            });

            // Notification button
            DOM.notificationBtn.addEventListener('click', showNotifications);

            // Modal close
            DOM.closeModal.addEventListener('click', closeModal);
            DOM.matchModal.addEventListener('click', (e) => {
                if (e.target === DOM.matchModal) closeModal();
            });

            // Beforeunload - save state
            window.addEventListener('beforeunload', () => {
                localStorage.setItem('legashot_favorites', JSON.stringify(STATE.favorites));
            });

            // Visibility change - pause live updates when tab is inactive
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    clearLiveUpdates();
                } else if (STATE.currentTab === 'live') {
                    setupLiveUpdates();
                }
            });
        }

        // Register Service Worker for caching
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful');
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            }
        }

        // Switch between tabs
        function switchTab(tab) {
            // Update last tab switch time
            const now = Date.now();
            const timeSinceLastSwitch = now - STATE.lastTabSwitchTime;
            STATE.lastTabSwitchTime = now;

            // If more than threshold time has passed, refresh from cache
            if (timeSinceLastSwitch > STATE.TAB_SWITCH_CACHE_THRESHOLD) {
                const cachedData = getCachedData(tab);
                if (cachedData) {
                    updateStateFromCache(cachedData, tab);
                    return;
                }
            }

            STATE.currentTab = tab;
            updateActiveTabUI();

            // Clear any existing live updates
            clearLiveUpdates();

            // Show/hide appropriate containers
            if (tab === 'standings') {
                DOM.standingsContainer.style.display = 'block';
                DOM.matchesContent.style.display = 'none';
                loadStandings();
            } else {
                DOM.standingsContainer.style.display = 'none';
                DOM.matchesContent.style.display = 'block';
                
                // Show league filter for matches tabs except favorites
                DOM.leagueFilter.style.display = tab === 'favorites' ? 'none' : 'block';
                
                filterMatches();
                
                // Setup live updates for live matches tab
                if (tab === 'live') {
                    setupLiveUpdates();
                }
            }
        }

        // Update active tab UI
        function updateActiveTabUI() {
            DOM.tabs.forEach(tab => {
                if (tab.dataset.tab === STATE.currentTab) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
        }

        // Load matches from API or cache
        function loadMatches() {
            const cachedMatches = getCachedData('matches');
            if (cachedMatches && !isCacheExpired(cachedMatches.timestamp)) {
                updateStateFromCache(cachedMatches, 'matches');
                return;
            }

            fetchMatchesFromAPI();
        }

        // Fetch matches from API
        function fetchMatchesFromAPI() {
            if (STATE.apiRequestsCount >= API_CONFIG.REQUEST_LIMIT) {
                showError('لقد وصلت إلى الحد الأقصى لطلبات API اليوم. يرجى المحاولة لاحقًا.');
                return;
            }

            showLoading(DOM.matchesContent);

            // Get today's date in YYYY-MM-DD format
            const today = new Date().toISOString().split('T')[0];
            
            // Construct API URL
            const url = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.FIXTURES}?date=${today}`;
            
            fetch(url, {
                headers: {
                    'x-apisports-key': getFullApiKey(),
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                STATE.apiRequestsCount++;
                return response.json();
            })
            .then(data => {
                if (data.response && data.response.length > 0) {
                    STATE.matches = data.response;
                    STATE.lastUpdateTime = Date.now();
                    
                    // Cache the data
                    cacheData('matches', {
                        timestamp: STATE.lastUpdateTime,
                        data: STATE.matches
                    });
                    
                    filterMatches();
                } else {
                    showError('لا توجد مباريات متاحة اليوم.');
                }
            })
            .catch(error => {
                console.error('Error fetching matches:', error);
                showError('حدث خطأ أثناء جلب بيانات المباريات. يرجى المحاولة لاحقًا.');
            });
        }

        // Load leagues from API or cache
        function loadLeagues() {
            const cachedLeagues = getCachedData('leagues');
            if (cachedLeagues && !isCacheExpired(cachedLeagues.timestamp)) {
                updateStateFromCache(cachedLeagues, 'leagues');
                return;
            }

            fetchLeaguesFromAPI();
        }

        // Fetch leagues from API
        function fetchLeaguesFromAPI() {
            if (STATE.apiRequestsCount >= API_CONFIG.REQUEST_LIMIT) {
                console.warn('API request limit reached');
                return;
            }

            const url = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.LEAGUES}`;
            
            fetch(url, {
                headers: {
                    'x-apisports-key': getFullApiKey(),
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                STATE.apiRequestsCount++;
                return response.json();
            })
            .then(data => {
                if (data.response && data.response.length > 0) {
                    STATE.leagues = data.response;
                    
                    // Cache the data
                    cacheData('leagues', {
                        timestamp: Date.now(),
                        data: STATE.leagues
                    });
                    
                    populateLeagueFilter();
                }
            })
            .catch(error => {
                console.error('Error fetching leagues:', error);
            });
        }

        // Load standings from API or cache
        function loadStandings() {
            const cachedStandings = getCachedData('standings');
            if (cachedStandings && !isCacheExpired(cachedStandings.timestamp)) {
                updateStateFromCache(cachedStandings, 'standings');
                return;
            }

            fetchStandingsFromAPI();
        }

        // Fetch standings from API
        function fetchStandingsFromAPI() {
            if (STATE.apiRequestsCount >= API_CONFIG.REQUEST_LIMIT) {
                showError('لقد وصلت إلى الحد الأقصى لطلبات API اليوم. يرجى المحاولة لاحقًا.', DOM.standingsContainer);
                return;
            }

            showLoading(DOM.standingsContainer);

            // Get current season year
            const currentYear = new Date().getFullYear();
            const season = `${currentYear}-${currentYear + 1}`;
            
            // Construct API URL - example for Premier League (id: 39)
            const url = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.STANDINGS}?league=39&season=${currentYear}`;
            
            fetch(url, {
                headers: {
                    'x-apisports-key': getFullApiKey(),
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                STATE.apiRequestsCount++;
                return response.json();
            })
            .then(data => {
                if (data.response && data.response.length > 0) {
                    const standingsData = data.response[0];
                    
                    // Cache the data
                    cacheData('standings', {
                        timestamp: Date.now(),
                        data: standingsData
                    });
                    
                    renderStandings(standingsData);
                } else {
                    showError('لا توجد بيانات ترتيب متاحة.', DOM.standingsContainer);
                }
            })
            .catch(error => {
                console.error('Error fetching standings:', error);
                showError('حدث خطأ أثناء جلب بيانات الترتيب. يرجى المحاولة لاحقًا.', DOM.standingsContainer);
            });
        }

        // Filter matches based on current tab, league filter and search query
        function filterMatches() {
            let filtered = [...STATE.matches];

            // Filter by tab
            switch (STATE.currentTab) {
                case 'live':
                    filtered = filtered.filter(match => match.fixture.status.short === 'LIVE');
                    break;
                case 'upcoming':
                    filtered = filtered.filter(match => 
                        ['NS', 'TBD'].includes(match.fixture.status.short)
                    );
                    break;
                case 'finished':
                    filtered = filtered.filter(match => 
                        ['FT', 'AET', 'PEN'].includes(match.fixture.status.short)
                    );
                    break;
                case 'favorites':
                    filtered = filtered.filter(match => 
                        STATE.favorites.includes(match.fixture.id.toString())
                    );
                    break;
            }

            // Filter by league
            if (STATE.selectedLeague) {
                filtered = filtered.filter(match => 
                    match.league.id.toString() === STATE.selectedLeague
                );
            }

            // Filter by search query
            if (STATE.searchQuery) {
                const query = STATE.searchQuery.toLowerCase();
                filtered = filtered.filter(match => 
                    match.teams.home.name.toLowerCase().includes(query) ||
                    match.teams.away.name.toLowerCase().includes(query) ||
                    match.league.name.toLowerCase().includes(query) ||
                    match.league.country.toLowerCase().includes(query)
                );
            }

            STATE.filteredMatches = filtered;
            renderMatches();
        }

        // Render matches to the DOM
        function renderMatches() {
            if (STATE.filteredMatches.length === 0) {
                DOM.matchesContent.innerHTML = `
                    <div class="error-message">
                        لا توجد مباريات متطابقة مع معايير البحث.
                    </div>
                `;
                return;
            }

            // Sort matches: live first, then upcoming, then finished
            const sortedMatches = [...STATE.filteredMatches].sort((a, b) => {
                // Live matches first
                if (a.fixture.status.short === 'LIVE' && b.fixture.status.short !== 'LIVE') return -1;
                if (b.fixture.status.short === 'LIVE' && a.fixture.status.short !== 'LIVE') return 1;
                
                // Then sort by time: upcoming matches in chronological order
                if (a.fixture.status.short === 'NS' && b.fixture.status.short === 'NS') {
                    return new Date(a.fixture.date) - new Date(b.fixture.date);
                }
                
                // Finished matches last
                if (['FT', 'AET', 'PEN'].includes(a.fixture.status.short) && 
                    ['FT', 'AET', 'PEN'].includes(b.fixture.status.short)) {
                    return new Date(b.fixture.date) - new Date(a.fixture.date);
                }
                
                // Default: upcoming before finished
                if (['NS', 'TBD'].includes(a.fixture.status.short)) return -1;
                return 1;
            });

            let matchesHTML = '<div class="matches-container">';
            
            // Add an ad space after every 4 matches
            sortedMatches.forEach((match, index) => {
                if (index % 4 === 0 && index !== 0) {
                    matchesHTML += `
                        <div class="ad-space ad-card">
                            مساحة إعلانية - بطاقة
                        </div>
                    `;
                }
                
                matchesHTML += createMatchCard(match);
            });

            matchesHTML += '</div>';
            
            DOM.matchesContent.innerHTML = matchesHTML;
            
            // Add event listeners to match cards
            document.querySelectorAll('.match-card').forEach(card => {
                const matchId = card.dataset.matchId;
                card.addEventListener('click', () => openMatchDetails(matchId));
            });
            
            // Add event listeners to favorite buttons
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavorite(btn.dataset.matchId);
                });
            });
            
            // Add event listeners to share buttons
            document.querySelectorAll('.share-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openShareModal(btn.dataset.matchId);
                });
            });
        }

        // Create HTML for a match card
        function createMatchCard(match) {
            const isFavorite = STATE.favorites.includes(match.fixture.id.toString());
            const status = match.fixture.status;
            const isLive = status.short === 'LIVE';
            const isFinished = ['FT', 'AET', 'PEN'].includes(status.short);
            const isUpcoming = ['NS', 'TBD'].includes(status.short);
            
            let statusClass = '';
            let statusText = '';
            let score = '';
            let matchTime = '';
            
            if (isLive) {
                statusClass = 'status-live';
                statusText = `${status.elapsed}'`;
                score = `${match.goals.home} - ${match.goals.away}`;
            } else if (isFinished) {
                statusClass = 'status-finished';
                statusText = 'انتهت';
                score = `${match.goals.home} - ${match.goals.away}`;
                if (match.fixture.status.short === 'PEN') {
                    score += ` (${match.score.penalty.home} - ${match.score.penalty.away})`;
                }
            } else {
                statusClass = 'status-upcoming';
                statusText = new Date(match.fixture.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                score = 'VS';
                matchTime = new Date(match.fixture.date).toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
            }
            
            // Countdown for upcoming matches
            let countdownHTML = '';
            if (isUpcoming) {
                const matchDate = new Date(match.fixture.date);
                countdownHTML = `<div class="countdown" data-match-date="${match.fixture.date}"></div>`;
            }
            
            return `
                <div class="match-card ${isLive ? 'live' : isFinished ? 'finished' : 'upcoming'} ${isFavorite ? 'favorite' : ''}" data-match-id="${match.fixture.id}">
                    <div class="match-header">
                        <div class="league-info">
                            <img src="${match.league.logo}" alt="${match.league.name}" class="league-logo" onerror="this.src='https://via.placeholder.com/30'">
                            <span class="league-name">${match.league.name}</span>
                        </div>
                        <div class="match-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="match-content">
                        <div class="teams">
                            <div class="team">
                                <img src="${match.teams.home.logo}" alt="${match.teams.home.name}" class="team-logo" onerror="this.src='https://via.placeholder.com/60'">
                                <span class="team-name">${match.teams.home.name}</span>
                            </div>
                            <div class="match-score">
                                <div class="score">${score}</div>
                                <div class="match-time">${matchTime}</div>
                                ${countdownHTML}
                            </div>
                            <div class="team">
                                <img src="${match.teams.away.logo}" alt="${match.teams.away.name}" class="team-logo" onerror="this.src='https://via.placeholder.com/60'">
                                <span class="team-name">${match.teams.away.name}</span>
                            </div>
                        </div>
                        <div class="match-details">
                            <div class="match-venue">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${match.fixture.venue?.name || 'غير معروف'}</span>
                            </div>
                            <div class="match-actions">
                                <button class="action-btn favorite-btn" data-match-id="${match.fixture.id}">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button class="action-btn share-btn" data-match-id="${match.fixture.id}">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render standings to the DOM
        function renderStandings(standingsData) {
            if (!standingsData || !standingsData.league || !standingsData.league.standings) {
                DOM.standingsContainer.innerHTML = `
                    <div class="error-message">
                        لا توجد بيانات ترتيب متاحة للدوري المحدد.
                    </div>
                `;
                return;
            }

            const standings = standingsData.league.standings[0];
            let standingsHTML = `
                <h2>${standingsData.league.name} - ${standingsData.league.season}</h2>
                <div class="table-responsive">
                    <table class="standings-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الفريق</th>
                                <th>ل</th>
                                <th>ف</th>
                                <th>ت</th>
                                <th>خ</th>
                                <th>له</th>
                                <th>عليه</th>
                                <th>+/-</th>
                                <th>نقاط</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            standings.forEach((team, index) => {
                const isPromotion = index < 4; // Top 4 teams (example for Champions League spots)
                const isRelegation = index >= standings.length - 3; // Bottom 3 teams (example for relegation)
                
                standingsHTML += `
                    <tr class="${isPromotion ? 'promotion' : ''} ${isRelegation ? 'relegation' : ''}">
                        <td class="position">${team.rank}</td>
                        <td>
                            <div class="team-standing">
                                <span class="team-standing-name">${team.team.name}</span>
                                <img src="${team.team.logo}" alt="${team.team.name}" class="team-standing-logo" onerror="this.src='https://via.placeholder.com/25'">
                            </div>
                        </td>
                        <td>${team.all.played}</td>
                        <td>${team.all.win}</td>
                        <td>${team.all.draw}</td>
                        <td>${team.all.lose}</td>
                        <td>${team.all.goals.for}</td>
                        <td>${team.all.goals.against}</td>
                        <td>${team.goalsDiff}</td>
                        <td><strong>${team.points}</strong></td>
                    </tr>
                `;
            });

            standingsHTML += `
                        </tbody>
                    </table>
                </div>
                <div class="standings-notes" style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                    <p><span style="background: rgba(40, 167, 69, 0.1); padding: 2px 5px;">أخضر</span>: تأهل إلى البطولات القارية</p>
                    <p><span style="background: rgba(220, 53, 69, 0.1); padding: 2px 5px;">أحمر</span>: هبوط إلى دوري أقل</p>
                </div>
            `;

            DOM.standingsContainer.innerHTML = standingsHTML;
        }

        // Populate league filter dropdown
        function populateLeagueFilter() {
            if (STATE.leagues.length === 0) return;

            // Get unique leagues from matches
            const leagueMap = new Map();
            STATE.matches.forEach(match => {
                if (!leagueMap.has(match.league.id)) {
                    leagueMap.set(match.league.id, match.league);
                }
            });

            // Sort leagues by country and name
            const sortedLeagues = Array.from(leagueMap.values()).sort((a, b) => {
                if (a.country === b.country) {
                    return a.name.localeCompare(b.name);
                }
                return a.country.localeCompare(b.country);
            });

            // Clear and populate select
            DOM.leagueSelect.innerHTML = '<option value="">كل الدوريات</option>';
            
            sortedLeagues.forEach(league => {
                const option = document.createElement('option');
                option.value = league.id;
                option.textContent = `${league.name} (${league.country})`;
                DOM.leagueSelect.appendChild(option);
            });
        }

        // Open match details modal
        function openMatchDetails(matchId) {
            STATE.currentMatchId = matchId;
            STATE.isModalOpen = true;
            
            // Show modal with loading state
            DOM.matchModal.style.display = 'block';
            DOM.modalTitle.textContent = 'تفاصيل المباراة';
            DOM.modalBody.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            `;
            
            // Check cache first
            const cachedMatch = getCachedData(`match_${matchId}`);
            if (cachedMatch && !isCacheExpired(cachedMatch.timestamp)) {
                renderMatchDetails(cachedMatch.data);
                return;
            }
            
            // Fetch from API if not in cache or expired
            fetchMatchDetails(matchId);
        }

        // Fetch match details from API
        function fetchMatchDetails(matchId) {
            if (STATE.apiRequestsCount >= API_CONFIG.REQUEST_LIMIT) {
                showError('لقد وصلت إلى الحد الأقصى لطلبات API اليوم. يرجى المحاولة لاحقًا.', DOM.modalBody);
                return;
            }

            const url = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.FIXTURES}?id=${matchId}`;
            
            fetch(url, {
                headers: {
                    'x-apisports-key': getFullApiKey(),
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                STATE.apiRequestsCount++;
                return response.json();
            })
            .then(data => {
                if (data.response && data.response.length > 0) {
                    const matchDetails = data.response[0];
                    
                    // Cache the data
                    cacheData(`match_${matchId}`, {
                        timestamp: Date.now(),
                        data: matchDetails
                    });
                    
                    renderMatchDetails(matchDetails);
                } else {
                    showError('لا توجد تفاصيل متاحة لهذه المباراة.', DOM.modalBody);
                }
            })
            .catch(error => {
                console.error('Error fetching match details:', error);
                showError('حدث خطأ أثناء جلب تفاصيل المباراة. يرجى المحاولة لاحقًا.', DOM.modalBody);
            });
        }

        // Render match details in modal
        function renderMatchDetails(match) {
            const fixture = match.fixture;
            const teams = match.teams;
            const goals = match.goals;
            const score = match.score;
            const events = match.events || [];
            const league = match.league;
            const status = fixture.status;
            
            // Basic match info
            let matchInfoHTML = `
                <div class="match-info">
                    <div class="match-info-section">
                        <h4 class="info-title">معلومات المباراة</h4>
                        <div class="info-item">
                            <span class="info-label">الدوري:</span>
                            <span class="info-value">${league.name} (${league.country})</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">الحالة:</span>
                            <span class="info-value">${status.long}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">التاريخ والوقت:</span>
                            <span class="info-value">${new Date(fixture.date).toLocaleString()}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">الملعب:</span>
                            <span class="info-value">${fixture.venue?.name || 'غير معروف'} (${fixture.venue?.city || 'غير معروف'})</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">الحكم:</span>
                            <span class="info-value">${fixture.referee || 'غير معروف'}</span>
                        </div>
                    </div>
                    
                    <div class="match-info-section">
                        <h4 class="info-title">النتيجة</h4>
                        <div class="info-item">
                            <span class="info-label">${teams.home.name}:</span>
                            <span class="info-value">${goals.home}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">${teams.away.name}:</span>
                            <span class="info-value">${goals.away}</span>
                        </div>
            `;
            
            // Add penalty shootout if available
            if (score.penalty && score.penalty.home !== null && score.penalty.away !== null) {
                matchInfoHTML += `
                        <div class="info-item">
                            <span class="info-label">ركلات الترجيح:</span>
                            <span class="info-value">${score.penalty.home} - ${score.penalty.away}</span>
                        </div>
                `;
            }
            
            // Add halftime score if available
            if (score.halftime && score.halftime.home !== null && score.halftime.away !== null) {
                matchInfoHTML += `
                        <div class="info-item">
                            <span class="info-label">نصف المباراة:</span>
                            <span class="info-value">${score.halftime.home} - ${score.halftime.away}</span>
                        </div>
                `;
            }
            
            // Add fulltime score if different from current score
            if (score.fulltime && score.fulltime.home !== null && score.fulltime.away !== null && 
                (score.fulltime.home !== goals.home || score.fulltime.away !== goals.away)) {
                matchInfoHTML += `
                        <div class="info-item">
                            <span class="info-label">نهاية الوقت الأصلي:</span>
                            <span class="info-value">${score.fulltime.home} - ${score.fulltime.away}</span>
                        </div>
                `;
            }
            
            matchInfoHTML += `
                    </div>
                </div>
            `;
            
            // Events timeline
            let eventsHTML = '';
            if (events.length > 0) {
                eventsHTML = `
                    <div class="events-timeline">
                        <h4 class="info-title">أحداث المباراة</h4>
                `;
                
                // Sort events by time (ascending)
                const sortedEvents = [...events].sort((a, b) => a.time.elapsed - b.time.elapsed);
                
                sortedEvents.forEach(event => {
                    let eventIconClass = '';
                    let eventIcon = '';
                    
                    switch (event.type) {
                        case 'Goal':
                            eventIconClass = 'goal';
                            eventIcon = '⚽';
                            break;
                        case 'Card':
                            if (event.detail === 'Yellow Card') {
                                eventIconClass = 'yellow-card';
                                eventIcon = '🟨';
                            } else if (event.detail === 'Red Card') {
                                eventIconClass = 'red-card';
                                eventIcon = '🟥';
                            }
                            break;
                        case 'subst':
                            eventIconClass = 'substitution';
                            eventIcon = '🔄';
                            break;
                        default:
                            eventIconClass = 'other';
                            eventIcon = '•';
                    }
                    
                    const teamName = event.team.id === teams.home.id ? teams.home.name : teams.away.name;
                    const playerName = event.player.name || 'لاعب';
                    
                    eventsHTML += `
                        <div class="timeline-item">
                            <div class="timeline-time">${event.time.elapsed}'${event.time.extra ? `+${event.time.extra}` : ''}</div>
                            <div class="timeline-event">
                                <span class="event-team">${teamName}</span>
                                <div class="event-icon ${eventIconClass}">${eventIcon}</div>
                                <span class="event-player">${playerName} - ${event.detail}</span>
                            </div>
                        </div>
                    `;
                });
                
                eventsHTML += '</div>';
            } else {
                eventsHTML = '<p>لا توجد أحداث مسجلة لهذه المباراة.</p>';
            }
            
            // Lineups and statistics could be added here if available in the API
            
            DOM.modalBody.innerHTML = matchInfoHTML + eventsHTML;
            
            // Add animation
            DOM.modalBody.classList.add('fade-in');
            setTimeout(() => {
                DOM.modalBody.classList.remove('fade-in');
            }, 500);
        }

        // Close modal
        function closeModal() {
            DOM.matchModal.style.display = 'none';
            STATE.isModalOpen = false;
            STATE.currentMatchId = null;
        }

        // Open share modal
        function openShareModal(matchId) {
            const match = STATE.matches.find(m => m.fixture.id.toString() === matchId);
            if (!match) return;
            
            // Position share modal near the clicked button
            const shareBtn = document.querySelector(`.share-btn[data-match-id="${matchId}"]`);
            const rect = shareBtn.getBoundingClientRect();
            
            DOM.shareModal.style.display = 'block';
            DOM.shareModal.style.top = `${rect.top - 60}px`;
            DOM.shareModal.style.left = `${rect.left - 100}px`;
            
            // Add event listeners to share buttons
            document.querySelectorAll('.share-btn[data-platform]').forEach(btn => {
                btn.addEventListener('click', () => shareMatch(match, btn.dataset.platform));
            });
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeShareModalOutside);
            }, 100);
        }

        // Close share modal when clicking outside
        function closeShareModalOutside(e) {
            if (!DOM.shareModal.contains(e.target)) {
                DOM.shareModal.style.display = 'none';
                document.removeEventListener('click', closeShareModalOutside);
            }
        }

        // Share match on social media
        function shareMatch(match, platform) {
            const matchUrl = `https://legashot.com/match/${match.fixture.id}`;
            const text = `تابع مباراة ${match.teams.home.name} vs ${match.teams.away.name} على ليجا شوت`;
            
            switch (platform) {
                case 'facebook':
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(matchUrl)}`, '_blank');
                    break;
                case 'twitter':
                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(matchUrl)}`, '_blank');
                    break;
                case 'whatsapp':
                    window.open(`https://wa.me/?text=${encodeURIComponent(`${text} ${matchUrl}`)}`, '_blank');
                    break;
                case 'copy':
                    navigator.clipboard.writeText(`${text} ${matchUrl}`).then(() => {
                        alert('تم نسخ الرابط إلى الحافظة!');
                    });
                    break;
            }
            
            DOM.shareModal.style.display = 'none';
            document.removeEventListener('click', closeShareModalOutside);
        }

        // Toggle match as favorite
        function toggleFavorite(matchId) {
            const index = STATE.favorites.indexOf(matchId);
            
            if (index === -1) {
                STATE.favorites.push(matchId);
            } else {
                STATE.favorites.splice(index, 1);
            }
            
            // Update UI
            const matchCard = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
            if (matchCard) {
                matchCard.classList.toggle('favorite');
            }
            
            // Update favorites tab if active
            if (STATE.currentTab === 'favorites') {
                filterMatches();
            }
            
            // Save to localStorage
            localStorage.setItem('legashot_favorites', JSON.stringify(STATE.favorites));
            
            // Show notification
            const match = STATE.matches.find(m => m.fixture.id.toString() === matchId);
            if (match) {
                const action = index === -1 ? 'تمت الإضافة إلى' : 'تمت الإزالة من';
                addNotification(`${action} المفضلة: ${match.teams.home.name} vs ${match.teams.away.name}`);
            }
        }

        // Add notification
        function addNotification(message) {
            STATE.notifications.push({
                id: Date.now(),
                message: message,
                timestamp: new Date().toLocaleTimeString(),
                read: false
            });
            
            updateNotificationBadge();
        }

        // Update notification badge
        function updateNotificationBadge() {
            const unreadCount = STATE.notifications.filter(n => !n.read).length;
            DOM.notificationBadge.textContent = unreadCount;
            DOM.notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }

        // Show notifications
        function showNotifications() {
            // Mark all as read
            STATE.notifications.forEach(n => n.read = true);
            updateNotificationBadge();
            
            // Create notification popup
            const notificationPopup = document.createElement('div');
            notificationPopup.className = 'notification-popup';
            notificationPopup.style.position = 'fixed';
            notificationPopup.style.top = '60px';
            notificationPopup.style.right = '20px';
            notificationPopup.style.background = 'white';
            notificationPopup.style.borderRadius = 'var(--border-radius)';
            notificationPopup.style.boxShadow = 'var(--box-shadow)';
            notificationPopup.style.padding = '1rem';
            notificationPopup.style.zIndex = '1000';
            notificationPopup.style.maxWidth = '300px';
            notificationPopup.style.maxHeight = '400px';
            notificationPopup.style.overflowY = 'auto';
            
            if (STATE.notifications.length === 0) {
                notificationPopup.innerHTML = '<p>لا توجد تنبيهات جديدة</p>';
            } else {
                notificationPopup.innerHTML = '<h4 style="margin-bottom: 1rem;">التنبيهات</h4>';
                
                STATE.notifications.slice().reverse().forEach(notification => {
                    const notificationElement = document.createElement('div');
                    notificationElement.style.padding = '0.5rem 0';
                    notificationElement.style.borderBottom = '1px solid #eee';
                    notificationElement.innerHTML = `
                        <p style="margin-bottom: 0.2rem;">${notification.message}</p>
                        <small style="color: #666;">${notification.timestamp}</small>
                    `;
                    notificationPopup.appendChild(notificationElement);
                });
            }
            
            document.body.appendChild(notificationPopup);
            
            // Close when clicking outside
            setTimeout(() => {
                const closePopup = (e) => {
                    if (!notificationPopup.contains(e.target) {
                        notificationPopup.remove();
                        document.removeEventListener('click', closePopup);
                    }
                };
                document.addEventListener('click', closePopup);
            }, 100);
        }

        // Handle search
        function handleSearch() {
            STATE.searchQuery = DOM.searchInput.value.trim().toLowerCase();
            filterMatches();
        }

        // Setup live updates for live matches
        function setupLiveUpdates() {
            clearLiveUpdates();
            
            STATE.liveUpdateInterval = setInterval(() => {
                if (document.visibilityState === 'visible') {
                    fetchLiveMatches();
                }
            }, API_CONFIG.LIVE_UPDATE_INTERVAL);
        }

        // Clear live updates
        function clearLiveUpdates() {
            if (STATE.liveUpdateInterval) {
                clearInterval(STATE.liveUpdateInterval);
                STATE.liveUpdateInterval = null;
            }
        }

        // Fetch live matches only
        function fetchLiveMatches() {
            if (STATE.apiRequestsCount >= API_CONFIG.REQUEST_LIMIT) {
                console.warn('API request limit reached');
                return;
            }

            const url = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.FIXTURES}?live=all`;
            
            fetch(url, {
                headers: {
                    'x-apisports-key': getFullApiKey(),
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                STATE.apiRequestsCount++;
                return response.json();
            })
            .then(data => {
                if (data.response && data.response.length > 0) {
                    // Update live matches in state
                    const liveMatches = data.response;
                    
                    STATE.matches = STATE.matches.map(match => {
                        const liveMatch = liveMatches.find(m => m.fixture.id === match.fixture.id);
                        return liveMatch || match;
                    });
                    
                    STATE.lastUpdateTime = Date.now();
                    
                    // Cache the updated matches
                    cacheData('matches', {
                        timestamp: STATE.lastUpdateTime,
                        data: STATE.matches
                    });
                    
                    // Only re-render if on live tab
                    if (STATE.currentTab === 'live') {
                        filterMatches();
                    }
                    
                    // Update open match modal if it's a live match
                    if (STATE.isModalOpen && STATE.currentMatchId) {
                        const currentMatch = liveMatches.find(m => m.fixture.id === parseInt(STATE.currentMatchId));
                        if (currentMatch) {
                            renderMatchDetails(currentMatch);
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching live matches:', error);
            });
        }

        // Update countdown timers for upcoming matches
        function updateCountdowns() {
            document.querySelectorAll('.countdown').forEach(element => {
                const matchDate = new Date(element.dataset.matchDate);
                const now = new Date();
                const diff = matchDate - now;
                
                if (diff <= 0) {
                    element.textContent = 'بدأت المباراة';
                    return;
                }
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                let countdownText = '';
                if (days > 0) countdownText += `${days} يوم `;
                if (hours > 0 || days > 0) countdownText += `${hours} ساعة `;
                if (days === 0) countdownText += `${minutes} دقيقة `;
                if (days === 0 && hours === 0) countdownText += `${seconds} ثانية`;
                
                element.textContent = countdownText.trim() + ' حتى البداية';
            });
        }

        // Cache data with timestamp
        function cacheData(key, data) {
            try {
                localStorage.setItem(API_CONFIG.CACHE.PREFIX + key, JSON.stringify(data));
            } catch (e) {
                console.error('Error caching data:', e);
                // If storage is full, clear old cache
                if (e.name === 'QuotaExceededError') {
                    clearOldCache();
                    // Retry
                    localStorage.setItem(API_CONFIG.CACHE.PREFIX + key, JSON.stringify(data));
                }
            }
        }

        // Get cached data
        function getCachedData(key) {
            const cached = localStorage.getItem(API_CONFIG.CACHE.PREFIX + key);
            return cached ? JSON.parse(cached) : null;
        }

        // Check if cache is expired
        function isCacheExpired(timestamp) {
            return Date.now() - timestamp > API_CONFIG.CACHE.TTL;
        }

        // Clear old cache entries
        function clearOldCache() {
            const now = Date.now();
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(API_CONFIG.CACHE.PREFIX)) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (now - data.timestamp > API_CONFIG.CACHE.TTL * 2) { // Double TTL for buffer
                            localStorage.removeItem(key);
                        }
                    } catch (e) {
                        console.error('Error clearing cache:', e);
                    }
                }
            }
        }

        // Update state from cached data
        function updateStateFromCache(cachedData, type) {
            switch (type) {
                case 'matches':
                    STATE.matches = cachedData.data;
                    STATE.lastUpdateTime = cachedData.timestamp;
                    filterMatches();
                    break;
                case 'leagues':
                    STATE.leagues = cachedData.data;
                    populateLeagueFilter();
                    break;
                case 'standings':
                    renderStandings(cachedData.data);
                    break;
                case 'match':
                    renderMatchDetails(cachedData.data);
                    break;
                default:
                    console.warn('Unknown cache type:', type);
            }
        }

        // Show loading indicator
        function showLoading(container) {
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            `;
        }

        // Show error message
        function showError(message, container = DOM.matchesContent) {
            container.innerHTML = `
                <div class="error-message">
                    ${message}
                </div>
            `;
        }

        // Get full API key (security measure)
        function getFullApiKey() {
            // This is a security measure to avoid exposing the full key in the code
            // In a production environment, you should use a backend proxy to hide your API key
            return 'd25a' + 'ec9ad97ac2539d41139cf4490aab';
        }

        // Initialize countdown timers
        function initCountdownTimers() {
            updateCountdowns();
            setInterval(updateCountdowns, 1000);
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            init();
            initCountdownTimers();
            
            // Check for service worker update every hour
            setInterval(() => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistration().then(reg => {
                        if (reg) reg.update();
                    });
                }
            }, 3600000);
        });

        // Render ad spaces
        function renderAdSpaces() {
            // Top leaderboard ad
            const topAd = document.querySelector('.ad-leaderboard');
            if (topAd) {
                topAd.innerHTML = `
                    <div style="width: 728px; height: 90px; margin: 0 auto; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; border-radius: var(--border-radius);">
                        <p>إعلان 728x90</p>
                    </div>
                `;
            }
            
            // Responsive middle ad
            const middleAd = document.querySelector('.ad-responsive');
            if (middleAd) {
                middleAd.innerHTML = `
                    <div style="width: 100%; max-width: 300px; height: 250px; margin: 0 auto; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; border-radius: var(--border-radius);">
                        <p>إعلان متجاوب</p>
                    </div>
                `;
            }
            
            // Bottom leaderboard ad
            const bottomAd = document.createElement('div');
            bottomAd.className = 'ad-space ad-leaderboard';
            bottomAd.innerHTML = `
                <div style="width: 728px; height: 90px; margin: 0 auto; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; border-radius: var(--border-radius);">
                    <p>إعلان 728x90</p>
                </div>
            `;
            document.querySelector('.main-content').appendChild(bottomAd);
            
            // Dynamic ads between matches
            const matchCards = document.querySelectorAll('.match-card');
            matchCards.forEach((card, index) => {
                if ((index + 1) % 4 === 0) {
                    const ad = document.createElement('div');
                    ad.className = 'ad-space ad-card';
                    ad.innerHTML = `
                        <div style="width: 100%; height: 100px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; border-radius: var(--border-radius);">
                            <p>إعلان بطاقة</p>
                        </div>
                    `;
                    card.parentNode.insertBefore(ad, card.nextSibling);
                }
            });
        }
    </script>

    <!-- Service Worker Script -->
    <script>
        if ('serviceWorker' in navigator) {
            // Service worker for caching static assets and API responses
            const swScript = `
                const CACHE_NAME = 'legashot-v1';
                const API_CACHE_NAME = 'legashot-api-v1';
                const ASSETS = [
                    '/',
                    '/index.html',
                    '/styles.css',
                    '/app.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                    'https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap'
                ];

                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(ASSETS))
                            .then(() => self.skipWaiting())
                    );
                });

                self.addEventListener('activate', (event) => {
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cache => {
                                    if (cache !== CACHE_NAME && cache !== API_CACHE_NAME) {
                                        return caches.delete(cache);
                                    }
                                })
                            );
                        }).then(() => self.clients.claim())
                    );
                });

                self.addEventListener('fetch', (event) => {
                    const url = new URL(event.request.url);
                    
                    // Cache API responses
                    if (url.origin === 'https://v3.football.api-sports.io') {
                        event.respondWith(
                            caches.open(API_CACHE_NAME).then(cache => {
                                return cache.match(event.request).then(response => {
                                    // Return cached response if not expired
                                    if (response) {
                                        const cachedData = response.json();
                                        const cacheTime = new Date(response.headers.get('date')).getTime();
                                        const cacheAge = Date.now() - cacheTime;
                                        
                                        if (cacheAge < 15 * 60 * 1000) { // 15 minutes
                                            return response;
                                        }
                                    }
                                    
                                    // Fetch fresh data
                                    return fetch(event.request).then(networkResponse => {
                                        if (networkResponse.ok) {
                                            const clonedResponse = networkResponse.clone();
                                            cache.put(event.request, clonedResponse);
                                        }
                                        return networkResponse;
                                    }).catch(() => {
                                        // Fallback to cached response even if expired
                                        return response || new Response(JSON.stringify({error: 'No network connection'}), {
                                            headers: {'Content-Type': 'application/json'}
                                        });
                                    });
                                });
                            })
                        );
                        return;
                    }
                    
                    // For static assets
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => response || fetch(event.request))
                    );
                });

                // Background sync for live matches
                self.addEventListener('sync', (event) => {
                    if (event.tag === 'update-live-matches') {
                        event.waitUntil(updateLiveMatches());
                    }
                });

                async function updateLiveMatches() {
                    const apiUrl = 'https://v3.football.api-sports.io/fixtures?live=all';
                    const cache = await caches.open(API_CACHE_NAME);
                    
                    try {
                        const response = await fetch(apiUrl, {
                            headers: {
                                'x-apisports-key': 'd25aec9ad97ac2539d41139cf4490aab',
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            await cache.put(apiUrl, response.clone());
                            
                            // Send message to all clients
                            const clients = await self.clients.matchAll();
                            clients.forEach(client => {
                                client.postMessage({
                                    type: 'live-matches-updated',
                                    data: await response.json()
                                });
                            });
                        }
                    } catch (error) {
                        console.error('Background sync failed:', error);
                    }
                }
            `;

            // Create a Blob URL for the service worker script
            const blob = new Blob([swScript], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);

            // Register the service worker
            navigator.serviceWorker.register(swUrl)
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                    
                    // Register for periodic background sync (if supported)
                    if ('periodicSync' in registration) {
                        registration.periodicSync.register('update-live-matches', {
                            minInterval: 5 * 60 * 1000 // 5 minutes
                        }).then(() => {
                            console.log('Periodic background sync registered');
                        }).catch(err => {
                            console.error('Periodic background sync registration failed:', err);
                        });
                    }
                })
                .catch(err => {
                    console.error('Service Worker registration failed:', err);
                });
        }
    </script>
</body>
</html>
