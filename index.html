<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegaShot - متابعة المباريات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3a86ff;
            --secondary-color: #8338ec;
            --success-color: #06d6a0;
            --danger-color: #ef476f;
            --warning-color: #ffd166;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
            --bg-gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }

        /* Header Styles */
        header {
            background: var(--bg-gradient);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo img {
            height: 40px;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .search-container {
            display: flex;
            gap: 10px;
            width: 40%;
        }

        .search-container input {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            width: 100%;
            outline: none;
        }

        .search-container button {
            background-color: white;
            color: var(--primary-color);
            border: none;
            border-radius: 20px;
            padding: 0 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .search-container button:hover {
            background-color: var(--dark-color);
            color: white;
        }

        .user-actions {
            display: flex;
            gap: 15px;
        }

        .user-actions button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Main Content Styles */
        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Tabs Styles */
        .tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            font-weight: 600;
            color: #666;
        }

        .tab.active {
            color: var(--primary-color);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
        }

        .tab:hover:not(.active) {
            background-color: #f0f0f0;
        }

        .tab-badge {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        /* Filters Styles */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #ddd;
            outline: none;
            background-color: white;
            cursor: pointer;
        }

        /* Matches Grid Styles */
        .matches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* Match Card Styles */
        .match-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .match-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .match-card-header {
            background: var(--bg-gradient);
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-card-header .league {
            font-weight: 600;
        }

        .match-card-header .date {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .match-card-content {
            padding: 15px;
        }

        .teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40%;
        }

        .team-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 5px;
        }

        .team-name {
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .vs {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .match-time {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        .match-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--success-color);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .match-status.finished {
            background-color: var(--danger-color);
        }

        .match-status.upcoming {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }

        .match-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .match-action {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .match-action:hover {
            color: var(--secondary-color);
        }

        .favorite-btn {
            color: #ccc;
        }

        .favorite-btn.favorited {
            color: var(--danger-color);
        }

        /* Match Details Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 2rem auto;
            max-width: 800px;
            border-radius: 10px;
            overflow: hidden;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: var(--bg-gradient);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.2rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .match-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .match-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }

        .modal-team {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 30%;
        }

        .modal-team-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .modal-team-name {
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
        }

        .modal-vs {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .match-score {
            font-size: 2rem;
            font-weight: bold;
            margin: 0 20px;
        }

        .match-details {
            width: 100%;
            margin-top: 20px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 10px;
        }

        .detail-label {
            font-weight: bold;
            width: 150px;
            color: #666;
        }

        .detail-value {
            flex: 1;
        }

        .events-timeline {
            margin-top: 30px;
        }

        .events-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--primary-color);
        }

        .event-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .event-time {
            font-weight: bold;
            width: 40px;
            text-align: center;
        }

        .event-icon {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            color: var(--primary-color);
        }

        .event-description {
            flex: 1;
        }

        .event-team {
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }

        /* Notification Button */
        .notification-btn {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        /* Ad Spaces */
        .ad-space {
            background-color: #f0f0f0;
            border: 1px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            border-radius: 5px;
        }

        .ad-leaderboard {
            height: 90px;
        }

        .ad-responsive {
            height: 250px;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }

            .search-container {
                width: 100%;
            }

            .user-actions {
                width: 100%;
                justify-content: space-between;
            }

            .matches-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }

            .modal-team {
                width: 45%;
            }

            .modal-team-logo {
                width: 60px;
                height: 60px;
            }
        }

        @media (max-width: 480px) {
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 5px;
            }

            .tab {
                padding: 10px 15px;
            }

            .matches-grid {
                grid-template-columns: 1fr;
            }

            .match-teams {
                flex-direction: column;
                gap: 20px;
            }

            .modal-team {
                width: 100%;
            }
        }

        /* Animation Classes */
        .card-animation {
            animation: cardBounce 0.5s ease;
        }

        @keyframes cardBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-gradient);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            border: none;
            font-size: 1.2rem;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        body.dark-mode .match-card,
        body.dark-mode .modal-content {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        body.dark-mode .match-card-header,
        body.dark-mode .modal-header {
            background: #2a2a2a;
        }

        body.dark-mode .empty-state i {
            color: #444;
        }

        body.dark-mode .event-item {
            background-color: #2a2a2a;
        }

        body.dark-mode .ad-space {
            background-color: #2a2a2a;
            border-color: #444;
        }

        body.dark-mode .filter-select {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border-color: #444;
        }

        body.dark-mode .tab {
            color: #aaa;
        }

        body.dark-mode .tab.active {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-futbol"></i>
                <h1>LegaShot</h1>
            </div>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ابحث عن مباراة أو دوري...">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="user-actions">
                <button id="notifications-btn" class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                <button id="favorites-btn">
                    <i class="fas fa-heart"></i>
                    المفضلة
                </button>
                <button id="standings-btn">
                    <i class="fas fa-trophy"></i>
                    الترتيب
                </button>
            </div>
        </div>
    </header>

    <main>
        <div class="ad-space ad-leaderboard">
            <p>مساحة إعلانية - 728x90</p>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="all">كل المباريات</div>
            <div class="tab" data-tab="live">
                الجارية الآن <span class="tab-badge" id="live-count">0</span>
            </div>
            <div class="tab" data-tab="upcoming">
                القادمة <span class="tab-badge" id="upcoming-count">0</span>
            </div>
            <div class="tab" data-tab="finished">
                المنتهية <span class="tab-badge" id="finished-count">0</span>
            </div>
        </div>

        <div class="filters">
            <select id="league-filter" class="filter-select">
                <option value="all">كل الدوريات</option>
                <!-- Leagues will be populated by JavaScript -->
            </select>
            <select id="time-filter" class="filter-select">
                <option value="all">كل الأوقات</option>
                <option value="today">اليوم</option>
                <option value="tomorrow">غداً</option>
                <option value="week">هذا الأسبوع</option>
            </select>
        </div>

        <div id="matches-container">
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
        </div>

        <div class="ad-space ad-responsive">
            <p>مساحة إعلانية متجاوبة</p>
        </div>

        <div id="standings-container" style="display: none;">
            <!-- Standings will be populated by JavaScript -->
        </div>
    </main>

    <!-- Match Details Modal -->
    <div id="match-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">تفاصيل المباراة</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Dark Mode Toggle -->
    <button id="dark-mode-toggle" class="dark-mode-toggle">
        <i class="fas fa-moon"></i>
    </button>

    <script>
        // API Configuration
        const API_KEY = 'd25aec9ad97ac2539d41139cf4490aab';
        const API_BASE_URL = 'https://v3.football.api-sports.io';
        const CACHE_EXPIRY = 15 * 60 * 1000; // 15 minutes in milliseconds
        const LIVE_UPDATE_INTERVAL = 30 * 1000; // 30 seconds
        const TAB_SWITCH_CACHE_THRESHOLD = 30 * 1000; // 30 seconds

        // Application State
        const STATE = {
            matches: [],
            filteredMatches: [],
            leagues: [],
            favorites: JSON.parse(localStorage.getItem('favorites')) || [],
            currentTab: 'all',
            lastFetchTime: 0,
            lastTabSwitchTime: 0,
            liveUpdateInterval: null,
            darkMode: localStorage.getItem('darkMode') === 'true'
        };

        // DOM Elements
        const elements = {
            matchesContainer: document.getElementById('matches-container'),
            leagueFilter: document.getElementById('league-filter'),
            timeFilter: document.getElementById('time-filter'),
            searchInput: document.getElementById('search-input'),
            searchBtn: document.getElementById('search-btn'),
            tabs: document.querySelectorAll('.tab'),
            modal: document.getElementById('match-modal'),
            closeModal: document.querySelector('.close-modal'),
            modalBody: document.getElementById('modal-body'),
            modalTitle: document.getElementById('modal-title'),
            notificationsBtn: document.getElementById('notifications-btn'),
            favoritesBtn: document.getElementById('favorites-btn'),
            standingsBtn: document.getElementById('standings-btn'),
            standingsContainer: document.getElementById('standings-container'),
            liveCount: document.getElementById('live-count'),
            upcomingCount: document.getElementById('upcoming-count'),
            finishedCount: document.getElementById('finished-count'),
            darkModeToggle: document.getElementById('dark-mode-toggle')
        };

        // Initialize the application
        function init() {
            setupEventListeners();
            applyDarkMode();
            fetchData();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Tab switching
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Filter changes
            elements.leagueFilter.addEventListener('change', applyFilters);
            elements.timeFilter.addEventListener('change', applyFilters);
            elements.searchInput.addEventListener('input', applyFilters);
            elements.searchBtn.addEventListener('click', applyFilters);

            // Modal
            elements.closeModal.addEventListener('click', closeModal);
            elements.modal.addEventListener('click', (e) => {
                if (e.target === elements.modal) closeModal();
            });

            // Navigation buttons
            elements.favoritesBtn.addEventListener('click', showFavorites);
            elements.standingsBtn.addEventListener('click', toggleStandings);

            // Dark mode toggle
            elements.darkModeToggle.addEventListener('click', toggleDarkMode);
        }

        // Apply dark mode based on user preference
        function applyDarkMode() {
            if (STATE.darkMode) {
                document.body.classList.add('dark-mode');
                elements.darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                elements.darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        // Toggle dark mode
        function toggleDarkMode() {
            STATE.darkMode = !STATE.darkMode;
            localStorage.setItem('darkMode', STATE.darkMode);
            applyDarkMode();
        }

        // Fetch data from API or cache
        async function fetchData() {
            const cachedData = getCachedData('matches');
            
            if (cachedData && !shouldRefreshCache()) {
                STATE.matches = cachedData.matches;
                STATE.leagues = cachedData.leagues;
                STATE.lastFetchTime = cachedData.timestamp;
                renderMatches();
                populateLeagueFilter();
                return;
            }

            try {
                elements.matchesContainer.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                `;

                // Fetch matches and leagues in parallel
                const [matchesResponse, leaguesResponse] = await Promise.all([
                    fetchMatches(),
                    fetchLeagues()
                ]);

                STATE.matches = matchesResponse;
                STATE.leagues = leaguesResponse;
                STATE.lastFetchTime = Date.now();

                // Cache the data
                cacheData('matches', {
                    matches: STATE.matches,
                    leagues: STATE.leagues,
                    timestamp: STATE.lastFetchTime
                });

                renderMatches();
                populateLeagueFilter();
                startLiveUpdates();
            } catch (error) {
                console.error('Error fetching data:', error);
                elements.matchesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>حدث خطأ أثناء جلب البيانات. يرجى المحاولة لاحقاً.</p>
                    </div>
                `;
            }
        }

        // Fetch matches from API
        async function fetchMatches() {
            const today = new Date().toISOString().split('T')[0];
            const response = await fetch(`${API_BASE_URL}/fixtures?date=${today}`, {
                headers: {
                    'x-apisports-key': API_KEY
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch matches');
            }

            const data = await response.json();
            return data.response || [];
        }

        // Fetch leagues from API
        async function fetchLeagues() {
            const response = await fetch(`${API_BASE_URL}/leagues`, {
                headers: {
                    'x-apisports-key': API_KEY
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch leagues');
            }

            const data = await response.json();
            return data.response || [];
        }

        // Get cached data
        function getCachedData(key) {
            const cached = localStorage.getItem(key);
            if (!cached) return null;

            const data = JSON.parse(cached);
            if (Date.now() - data.timestamp > CACHE_EXPIRY) {
                localStorage.removeItem(key);
                return null;
            }

            return data;
        }

        // Cache data
        function cacheData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        // Check if cache should be refreshed
        function shouldRefreshCache() {
            return Date.now() - STATE.lastFetchTime > CACHE_EXPIRY;
        }

        // Start live updates for ongoing matches
        function startLiveUpdates() {
            if (STATE.liveUpdateInterval) {
                clearInterval(STATE.liveUpdateInterval);
            }

            STATE.liveUpdateInterval = setInterval(() => {
                if (STATE.currentTab === 'live' || STATE.currentTab === 'all') {
                    updateLiveMatches();
                }
            }, LIVE_UPDATE_INTERVAL);
        }

        // Update live matches
        async function updateLiveMatches() {
            try {
                const liveMatches = STATE.matches.filter(match => 
                    match.fixture.status.short === '1H' || 
                    match.fixture.status.short === '2H' ||
                    match.fixture.status.short === 'HT' ||
                    match.fixture.status.short === 'ET' ||
                    match.fixture.status.short === 'P' ||
                    match.fixture.status.short === 'BT'
                );

                if (liveMatches.length === 0) return;

                const matchIds = liveMatches.map(match => match.fixture.id);
                const response = await fetch(`${API_BASE_URL}/fixtures?ids=${matchIds.join('-')}`, {
                    headers: {
                        'x-apisports-key': API_KEY
                    }
                });

                if (!response.ok) return;

                const data = await response.json();
                if (!data.response) return;

                // Update matches in state
                data.response.forEach(updatedMatch => {
                    const index = STATE.matches.findIndex(m => m.fixture.id === updatedMatch.fixture.id);
                    if (index !== -1) {
                        STATE.matches[index] = updatedMatch;
                    }
                });

                // Update cache
                cacheData('matches', {
                    matches: STATE.matches,
                    leagues: STATE.leagues,
                    timestamp: STATE.lastFetchTime
                });

                // Re-render if we're on the live tab
                if (STATE.currentTab === 'live' || STATE.currentTab === 'all') {
                    applyFilters();
                }
            } catch (error) {
                console.error('Error updating live matches:', error);
            }
        }

        // Populate league filter dropdown
        function populateLeagueFilter() {
            elements.leagueFilter.innerHTML = '<option value="all">كل الدوريات</option>';

            const uniqueLeagues = {};
            STATE.matches.forEach(match => {
                const leagueId = match.league.id;
                if (!uniqueLeagues[leagueId]) {
                    uniqueLeagues[leagueId] = match.league;
                }
            });

            Object.values(uniqueLeagues)
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(league => {
                    const option = document.createElement('option');
                    option.value = league.id;
                    option.textContent = league.name;
                    elements.leagueFilter.appendChild(option);
                });
        }

        // Switch between tabs
        function switchTab(tab) {
            // Update tab UI
            elements.tabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');

            // Check if we should refresh data based on time since last tab switch
            const now = Date.now();
            const shouldRefreshCache = now - STATE.lastTabSwitchTime > TAB_SWITCH_CACHE_THRESHOLD;
            
            STATE.currentTab = tab;
            STATE.lastTabSwitchTime = now;

            if (tab === 'standings') {
                toggleStandings();
            } else {
                elements.standingsContainer.style.display = 'none';
                elements.matchesContainer.style.display = 'block';
                
                if (shouldRefreshCache && (tab === 'live' || tab === 'all')) {
                    updateLiveMatches();
                } else {
                    applyFilters();
                }
            }
        }

        // Toggle standings view
        function toggleStandings() {
            if (elements.standingsContainer.style.display === 'none') {
                elements.matchesContainer.style.display = 'none';
                elements.standingsContainer.style.display = 'block';
                fetchStandings();
            } else {
                elements.standingsContainer.style.display = 'none';
                elements.matchesContainer.style.display = 'block';
            }
        }

        // Fetch standings for the selected league
        async function fetchStandings() {
            elements.standingsContainer.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            `;

            try {
                // For demo purposes, we'll use a default league (Premier League)
                const leagueId = 39; // Premier League
                const season = new Date().getFullYear();
                
                const response = await fetch(`${API_BASE_URL}/standings?league=${leagueId}&season=${season}`, {
                    headers: {
                        'x-apisports-key': API_KEY
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch standings');
                }

                const data = await response.json();
                renderStandings(data.response[0]);
            } catch (error) {
                console.error('Error fetching standings:', error);
                elements.standingsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>حدث خطأ أثناء جلب ترتيب الدوري. يرجى المحاولة لاحقاً.</p>
                    </div>
                `;
            }
        }

        // Render standings table
        function renderStandings(standingsData) {
            if (!standingsData || !standingsData.league) {
                elements.standingsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <p>لا تتوفر بيانات الترتيب حالياً.</p>
                    </div>
                `;
                return;
            }

            const { league } = standingsData;
            const standings = league.standings[0];

            let html = `
                <h2>${league.name} - ${league.season}</h2>
                <div class="standings-table">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الفريق</th>
                                <th>ل</th>
                                <th>ف</th>
                                <th>ت</th>
                                <th>خ</th>
                                <th>له</th>
                                <th>عليه</th>
                                <th>+/-</th>
                                <th>نقاط</th>
                                <th>آخر 5 مباريات</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            standings.forEach((team, index) => {
                const form = team.form ? team.form.split('').slice(0, 5) : [];
                let formHtml = '';
                
                form.forEach(result => {
                    let className = '';
                    if (result === 'W') className = 'win';
                    else if (result === 'D') className = 'draw';
                    else if (result === 'L') className = 'lose';
                    
                    formHtml += `<span class="${className}">${result}</span>`;
                });

                html += `
                    <tr>
                        <td>${team.rank}</td>
                        <td class="team-cell">
                            <img src="${team.team.logo}" alt="${team.team.name}" class="team-logo">
                            <span>${team.team.name}</span>
                        </td>
                        <td>${team.all.played}</td>
                        <td>${team.all.win}</td>
                        <td>${team.all.draw}</td>
                        <td>${team.all.lose}</td>
                        <td>${team.all.goals.for}</td>
                        <td>${team.all.goals.against}</td>
                        <td>${team.goalsDiff}</td>
                        <td><strong>${team.points}</strong></td>
                        <td class="form-cell">${formHtml}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            elements.standingsContainer.innerHTML = html;
        }

        // Apply filters based on user selection
        function applyFilters() {
            const leagueFilter = elements.leagueFilter.value;
            const timeFilter = elements.timeFilter.value;
            const searchQuery = elements.searchInput.value.toLowerCase();

            // Filter by tab first
            let filtered = STATE.matches;
            
            if (STATE.currentTab === 'live') {
                filtered = filtered.filter(match => 
                    match.fixture.status.short === '1H' || 
                    match.fixture.status.short === '2H' ||
                    match.fixture.status.short === 'HT' ||
                    match.fixture.status.short === 'ET' ||
                    match.fixture.status.short === 'P' ||
                    match.fixture.status.short === 'BT'
                );
            } else if (STATE.currentTab === 'upcoming') {
                filtered = filtered.filter(match => 
                    match.fixture.status.short === 'NS' || 
                    match.fixture.status.short === 'TBD'
                );
            } else if (STATE.currentTab === 'finished') {
                filtered = filtered.filter(match => 
                    match.fixture.status.short === 'FT' || 
                    match.fixture.status.short === 'AET' ||
                    match.fixture.status.short === 'PEN'
                );
            }

            // Filter by league
            if (leagueFilter !== 'all') {
                filtered = filtered.filter(match => match.league.id.toString() === leagueFilter);
            }

            // Filter by time
            if (timeFilter !== 'all') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);

                filtered = filtered.filter(match => {
                    const matchDate = new Date(match.fixture.date);
                    
                    if (timeFilter === 'today') {
                        return matchDate >= today && matchDate < tomorrow;
                    } else if (timeFilter === 'tomorrow') {
                        return matchDate >= tomorrow && matchDate < new Date(tomorrow.getTime() + 24 * 60 * 60 * 1000);
                    } else if (timeFilter === 'week') {
                        return matchDate >= today && matchDate < nextWeek;
                    }
                    return true;
                });
            }

            // Filter by search query
            if (searchQuery) {
                filtered = filtered.filter(match => 
                    match.teams.home.name.toLowerCase().includes(searchQuery) ||
                    match.teams.away.name.toLowerCase().includes(searchQuery) ||
                    match.league.name.toLowerCase().includes(searchQuery) ||
                    match.league.country.toLowerCase().includes(searchQuery)
                );
            }

            // Filter favorites if in favorites view
            if (STATE.currentTab === 'favorites') {
                filtered = filtered.filter(match => 
                    STATE.favorites.includes(match.fixture.id.toString())
                );
            }

            STATE.filteredMatches = filtered;
            renderMatches();
        }

        // Show favorite matches
        function showFavorites() {
            STATE.currentTab = 'favorites';
            elements.tabs.forEach(t => t.classList.remove('active'));
            applyFilters();
        }

        // Render matches to the DOM
        function renderMatches() {
            if (STATE.filteredMatches.length === 0) {
                elements.matchesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <p>لا توجد مباريات متاحة حالياً.</p>
                    </div>
                `;
                return;
            }

            // Count matches by status for badges
            const liveCount = STATE.matches.filter(match => 
                match.fixture.status.short === '1H' || 
                match.fixture.status.short === '2H' ||
                match.fixture.status.short === 'HT' ||
                match.fixture.status.short === 'ET' ||
                match.fixture.status.short === 'P' ||
                match.fixture.status.short === 'BT'
            ).length;

            const upcomingCount = STATE.matches.filter(match => 
                match.fixture.status.short === 'NS' || 
                match.fixture.status.short === 'TBD'
            ).length;

            const finishedCount = STATE.matches.filter(match => 
                match.fixture.status.short === 'FT' || 
                match.fixture.status.short === 'AET' ||
                match.fixture.status.short === 'PEN'
            ).length;

            elements.liveCount.textContent = liveCount;
            elements.upcomingCount.textContent = upcomingCount;
            elements.finishedCount.textContent = finishedCount;

            // Render matches
            let html = '<div class="matches-grid">';
            
            STATE.filteredMatches.forEach((match, index) => {
                const isFavorite = STATE.favorites.includes(match.fixture.id.toString());
                const matchDate = new Date(match.fixture.date);
                const now = new Date();
                const timeUntilMatch = matchDate - now;
                
                let statusText = '';
                let statusClass = '';
                
                if (match.fixture.status.short === 'NS') {
                    if (timeUntilMatch < 24 * 60 * 60 * 1000) {
                        // Less than 24 hours until match
                        const hours = Math.floor(timeUntilMatch / (60 * 60 * 1000));
                        const minutes = Math.floor((timeUntilMatch % (60 * 60 * 1000)) / (60 * 1000));
                        statusText = `تبدأ بعد ${hours} س ${minutes} د`;
                    } else {
                        // More than 24 hours until match
                        const options = { weekday: 'short', month: 'short', day: 'numeric' };
                        statusText = matchDate.toLocaleDateString('ar-AR', options);
                    }
                    statusClass = 'upcoming';
                } else if (match.fixture.status.short === '1H' || match.fixture.status.short === '2H' || 
                           match.fixture.status.short === 'HT' || match.fixture.status.short === 'ET' || 
                           match.fixture.status.short === 'P' || match.fixture.status.short === 'BT') {
                    statusText = `${match.fixture.status.elapsed}'`;
                    statusClass = 'live';
                } else if (match.fixture.status.short === 'FT' || match.fixture.status.short === 'AET' || 
                           match.fixture.status.short === 'PEN') {
                    statusText = 'انتهت';
                    statusClass = 'finished';
                } else {
                    statusText = match.fixture.status.long;
                }

                html += `
                    <div class="match-card" data-match-id="${match.fixture.id}">
                        <div class="match-card-header">
                            <span class="league">${match.league.name}</span>
                            <span class="date">${matchDate.toLocaleDateString('ar-AR')}</span>
                        </div>
                        <div class="match-card-content">
                            <div class="teams">
                                <div class="team">
                                    <img src="${match.teams.home.logo}" alt="${match.teams.home.name}" class="team-logo">
                                    <span class="team-name">${match.teams.home.name}</span>
                                </div>
                                <div class="vs">vs</div>
                                <div class="team">
                                    <img src="${match.teams.away.logo}" alt="${match.teams.away.name}" class="team-logo">
                                    <span class="team-name">${match.teams.away.name}</span>
                                </div>
                            </div>
                            <div class="match-time">
                                <span class="match-status ${statusClass}">${statusText}</span>
                                ${match.fixture.status.short === 'NS' ? 
                                    matchDate.toLocaleTimeString('ar-AR', { hour: '2-digit', minute: '2-digit' }) : 
                                    `${match.goals.home} - ${match.goals.away}`}
                            </div>
                            <div class="match-actions">
                                <button class="match-action favorite-btn ${isFavorite ? 'favorited' : ''}" 
                                    data-match-id="${match.fixture.id}">
                                    <i class="fas fa-heart"></i> المفضلة
                                </button>
                                <button class="match-action" data-match-id="${match.fixture.id}">
                                    <i class="fas fa-bell"></i> تنبيه
                                </button>
                                <button class="match-action view-details" data-match-id="${match.fixture.id}">
                                    <i class="fas fa-info-circle"></i> التفاصيل
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Insert ad after every 4 matches
                if ((index + 1) % 4 === 0) {
                    html += `
                        <div class="ad-space">
                            <p>إعلان</p>
                        </div>
                    `;
                }
            });

            html += '</div>';

            elements.matchesContainer.innerHTML = html;

            // Add event listeners to new elements
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', toggleFavorite);
            });

            document.querySelectorAll('.view-details').forEach(btn => {
                btn.addEventListener('click', showMatchDetails);
            });

            document.querySelectorAll('.match-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.match-action')) {
                        const matchId = card.dataset.matchId;
                        showMatchDetails({ currentTarget: { dataset: { matchId } } });
                    }
                });
            });
        }

        // Toggle match as favorite
        function toggleFavorite(e) {
            e.stopPropagation();
            const matchId = e.currentTarget.dataset.matchId;
            const index = STATE.favorites.indexOf(matchId);

            if (index === -1) {
                STATE.favorites.push(matchId);
            } else {
                STATE.favorites.splice(index, 1);
            }

            localStorage.setItem('favorites', JSON.stringify(STATE.favorites));
            e.currentTarget.classList.toggle('favorited');
        }

        // Show match details modal
        async function showMatchDetails(e) {
            e.stopPropagation();
            const matchId = e.currentTarget.dataset.matchId;
            const match = STATE.matches.find(m => m.fixture.id.toString() === matchId);

            if (!match) return;

            // Show loading state
            elements.modalBody.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            `;

            // Set modal title
            elements.modalTitle.textContent = `${match.teams.home.name} vs ${match.teams.away.name}`;

            // Open modal
            elements.modal.style.display = 'block';

            try {
                // Fetch additional match details (events, lineups, etc.)
                const [eventsResponse, statisticsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/fixtures/events?fixture=${matchId}`, {
                        headers: {
                            'x-apisports-key': API_KEY
                        }
                    }),
                    fetch(`${API_BASE_URL}/fixtures/statistics?fixture=${matchId}`, {
                        headers: {
                            'x-apisports-key': API_KEY
                        }
                    })
                ]);

                const eventsData = eventsResponse.ok ? await eventsResponse.json() : { response: [] };
                const statisticsData = statisticsResponse.ok ? await statisticsResponse.json() : { response: [] };

                renderMatchDetails(match, eventsData.response, statisticsData.response);
            } catch (error) {
                console.error('Error fetching match details:', error);
                renderMatchDetails(match, [], []);
            }
        }

        // Render match details in modal
        function renderMatchDetails(match, events, statistics) {
            const matchDate = new Date(match.fixture.date);
            const venue = match.fixture.venue;
            const referee = match.fixture.referee;
            
            let statusText = '';
            if (match.fixture.status.short === 'NS') {
                statusText = 'لم تبدأ بعد';
            } else if (match.fixture.status.short === '1H' || match.fixture.status.short === '2H' || 
                       match.fixture.status.short === 'HT' || match.fixture.status.short === 'ET' || 
                       match.fixture.status.short === 'P' || match.fixture.status.short === 'BT') {
                statusText = `جارية - الشوط ${match.fixture.status.short === '1H' ? 'الأول' : 'الثاني'} (${match.fixture.status.elapsed} دقيقة)`;
            } else if (match.fixture.status.short === 'FT' || match.fixture.status.short === 'AET' || 
                       match.fixture.status.short === 'PEN') {
                statusText = 'انتهت';
            } else {
                statusText = match.fixture.status.long;
            }

            let html = `
                <div class="match-info">
                    <div class="match-teams">
                        <div class="modal-team">
                            <img src="${match.teams.home.logo}" alt="${match.teams.home.name}" class="modal-team-logo">
                            <span class="modal-team-name">${match.teams.home.name}</span>
                        </div>
                        <div class="match-score">${match.goals.home} - ${match.goals.away}</div>
                        <div class="modal-team">
                            <img src="${match.teams.away.logo}" alt="${match.teams.away.name}" class="modal-team-logo">
                            <span class="modal-team-name">${match.teams.away.name}</span>
                        </div>
                    </div>

                    <div class="match-details">
                        <div class="detail-row">
                            <div class="detail-label">الحالة:</div>
                            <div class="detail-value">${statusText}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">الدوري:</div>
                            <div class="detail-value">${match.league.name} (${match.league.country})</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">التاريخ والوقت:</div>
                            <div class="detail-value">${matchDate.toLocaleString('ar-AR', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</div>
                        </div>
            `;

            if (venue && venue.name) {
                html += `
                    <div class="detail-row">
                        <div class="detail-label">الملعب:</div>
                        <div class="detail-value">${venue.name}${venue.city ? `, ${venue.city}` : ''}</div>
                    </div>
                `;
            }

            if (referee) {
                html += `
                    <div class="detail-row">
                        <div class="detail-label">الحكم:</div>
                        <div class="detail-value">${referee}</div>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            // Add statistics if available
            if (statistics.length > 0) {
                html += `
                    <div class="match-statistics">
                        <h3 class="events-title">إحصائيات المباراة</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>الإحصائية</th>
                                    <th>${match.teams.home.name}</th>
                                    <th>${match.teams.away.name}</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Common statistics to show
                const statsToShow = [
                    'Shots on Goal', 'Shots off Goal', 'Total Shots', 
                    'Blocked Shots', 'Shots insidebox', 'Shots outsidebox',
                    'Fouls', 'Corner Kicks', 'Offsides', 'Ball Possession',
                    'Yellow Cards', 'Red Cards', 'Goalkeeper Saves', 'Total passes',
                    'Passes accurate', 'Passes %'
                ];

                statsToShow.forEach(statName => {
                    const homeStat = statistics[0]?.statistics?.find(s => s.type === statName)?.value || '0';
                    const awayStat = statistics[1]?.statistics?.find(s => s.type === statName)?.value || '0';
                    
                    if (homeStat !== '0' || awayStat !== '0') {
                        html += `
                            <tr>
                                <td>${statName}</td>
                                <td>${homeStat}</td>
                                <td>${awayStat}</td>
                            </tr>
                        `;
                    }
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Add events timeline if available
            if (events.length > 0) {
                html += `
                    <div class="events-timeline">
                        <h3 class="events-title">أحداث المباراة</h3>
                `;

                events.forEach(event => {
                    const team = event.team.id === match.teams.home.id ? match.teams.home : match.teams.away;
                    let icon = 'fa-question-circle';
                    let color = 'var(--primary-color)';

                    switch (event.type) {
                        case 'Goal':
                            icon = 'fa-futbol';
                            color = 'var(--success-color)';
                            break;
                        case 'Card':
                            icon = event.detail === 'Yellow Card' ? 'fa-square' : 'fa-square-full';
                            color = event.detail === 'Yellow Card' ? 'var(--warning-color)' : 'var(--danger-color)';
                            break;
                        case 'subst':
                            icon = 'fa-exchange-alt';
                            break;
                        case 'Var':
                            icon = 'fa-video';
                            break;
                    }

                    html += `
                        <div class="event-item">
                            <div class="event-time">${event.time.elapsed}'${event.time.extra ? `+${event.time.extra}` : ''}</div>
                            <div class="event-icon" style="color: ${color}">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="event-description">
                                <span class="event-team">${team.name}</span> - ${event.player.name} (${event.detail})
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            // Add share buttons
            html += `
                <div class="share-buttons" style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="share-btn" data-platform="facebook" style="padding: 8px 15px; background: #3b5998; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fab fa-facebook-f"></i> مشاركة على فيسبوك
                    </button>
                    <button class="share-btn" data-platform="twitter" style="padding: 8px 15px; background: #1da1f2; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fab fa-twitter"></i> مشاركة على تويتر
                    </button>
                </div>
            `;

            elements.modalBody.innerHTML = html;

            // Add event listeners to share buttons
            document.querySelectorAll('.share-btn').forEach(btn => {
                btn.addEventListener('click', () => shareMatch(match, btn.dataset.platform));
            });
        }

        // Share match on social media
        function shareMatch(match, platform) {
            const url = `https://legashot.com/matches/${match.fixture.id}`;
            const text = `شاهد مباراة ${match.teams.home.name} vs ${match.teams.away.name} على LegaShot`;

            let shareUrl = '';
            if (platform === 'facebook') {
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            } else if (platform === 'twitter') {
                shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
            }

            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        }

        // Close modal
        function closeModal() {
            elements.modal.style.display = 'none';
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
